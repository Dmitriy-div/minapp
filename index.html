<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body { font-family: 'Inter', Arial, sans-serif; background: #f0f4f8; padding:16px; max-width:480px; margin:auto; }
h2,h3{color:#2ea6ff;margin-bottom:12px;}
.card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:16px;}
input,select,button{width:100%;padding:12px;margin:6px 0;border-radius:8px;border:1px solid #ddd;font-size:16px;}
button{background:#2ea6ff;color:white;border:none;cursor:pointer;font-weight:600;transition:background 0.3s;}
button:hover{background:#1b8cd8;}
.operation-card{display:flex;justify-content:space-between;padding:12px;margin:6px 0;border-radius:8px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.06);flex-wrap:wrap;font-size:14px;}
.operation-card span{margin:2px 0;}
</style>
</head>

<body>
<h2>üí∞ –°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</h2>

<div class="card">
<h3>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
<select id="type"></select>
<input id="amount" type="number" placeholder="–°—É–º–º–∞">
<select id="category"></select>
<input id="comment" type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
<button onclick="save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<div class="card">
<h3>–§–∏–ª—å—Ç—Ä –ø–æ –º–µ—Å—è—Ü—É</h3>
<select id="filterMonth"></select>
<select id="filterYear"></select>
<button onclick="loadReport()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</div>

<div class="card">
<h3>–û—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü</h3>
<div>–î–æ—Ö–æ–¥: <span id="totalIncome">0</span> | –†–∞—Å—Ö–æ–¥: <span id="totalExpense">0</span></div>
<canvas id="expenseChart" width="400" height="200"></canvas>
</div>

<div class="card">
<h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
<div id="operationsList"></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
const user = tg.initDataUnsafe?.user || {id:0};

/* üî¥ –í–°–¢–ê–í–¨ –°–í–û–ô URL Web App */
const SHEET_URL = "https://script.google.com/macros/s/AKfycbxzAGKzUAfh--yeQE88wAioSo-4ALt9see35SBViSGjWjYTJX-Yw-ciQDhyQGyxAEJBSg/exec";

/* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
const categories={income:["–ó–∞—Ä–ø–ª–∞—Ç–∞","–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞","–ü–æ–¥–∞—Ä–∫–∏","–ü—Ä–æ—á–µ–µ"],expense:["–ü—Ä–æ–¥—É–∫—Ç—ã","–ñ–∏–ª—å—ë","–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç","–î–µ—Ç–∏","–ó–¥–æ—Ä–æ–≤—å–µ","–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è","–û–¥–µ–∂–¥–∞","–ü—Ä–æ—á–µ–µ"]};
function updateCategories(){const type=document.getElementById("type").value;const select=document.getElementById("category");select.innerHTML="";categories[type].forEach(cat=>{const option=document.createElement("option");option.value=cat;option.textContent=cat;select.appendChild(option);});}
document.getElementById("type").addEventListener("change",updateCategories);
updateCategories();

/* –§–∏–ª—å—Ç—Ä –º–µ—Å—è—Ü–µ–≤ –∏ –≥–æ–¥–æ–≤ */
const monthSelect=document.getElementById("filterMonth");
const yearSelect=document.getElementById("filterYear");
const months=["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
const currentMonth=new Date().getMonth();
const currentYear=new Date().getFullYear();
months.forEach((m,i)=>monthSelect.options.add(new Option(m,i+1)));
monthSelect.value=currentMonth+1;
for(let y=currentYear-5;y<=currentYear+1;y++)yearSelect.options.add(new Option(y,y));
yearSelect.value=currentYear;

/* –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ */
async function save(){
  const data={type:document.getElementById("type").value,amount:document.getElementById("amount").value,category:document.getElementById("category").value,comment:document.getElementById("comment").value,user_id:user.id};
  if(!data.amount){tg.showPopup({title:"–û—à–∏–±–∫–∞",message:"–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É",buttons:[{type:"ok"}]});return;}
  try{
    await fetch(SHEET_URL,{method:"POST",body:JSON.stringify(data)});
    document.getElementById("amount").value="";
    document.getElementById("comment").value="";
    tg.showPopup({title:"–ì–æ—Ç–æ–≤–æ ‚úÖ",message:"–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞",buttons:[{type:"ok"}]});
    loadReport();
  }catch(e){console.error(e);tg.showPopup({title:"–û—à–∏–±–∫–∞ ‚ùå",message:"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å",buttons:[{type:"ok"}]);}
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞, –≥—Ä–∞—Ñ–∏–∫–∞ –∏ –æ–ø–µ—Ä–∞—Ü–∏–π */
async function loadReport(){
  try{
    const month=monthSelect.value;
    const year=yearSelect.value;
    const res=await fetch(`${SHEET_URL}?month=${month}&year=${year}`);
    const data=await res.json();
    document.getElementById("totalIncome").textContent=data.totalIncome.toFixed(2);
    document.getElementById("totalExpense").textContent=data.totalExpense.toFixed(2);

    const ctx=document.getElementById('expenseChart').getContext('2d');
    const labels=Object.keys(data.categorySums);
    const values=Object.values(data.categorySums);
    new Chart(ctx,{type:'pie',data:{labels,datasets:[{label:'–†–∞—Å—Ö–æ–¥—ã',data:values,backgroundColor:['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#C9CBCF','#FF6666']}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});

    const operationsDiv=document.getElementById("operationsList");
    operationsDiv.innerHTML="";
    data.operations.reverse().forEach(op=>{
      const div=document.createElement("div");
      div.className="operation-card";
      div.innerHTML=`<span>${op.date} | ${op.type}</span><span>${op.amount} | ${op.category}</span><span>${op.comment}</span>`;
      operationsDiv.appendChild(div);
    });

  }catch(e){console.error(e);}
}

loadReport();
</script>
</body>
</html>

