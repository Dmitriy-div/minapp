<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Flow Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { 
            --bg: #ffffff; --secondary-bg: #f4f4f7; --accent: #007aff; 
            --card: #ffffff; --text: #000000; --secondary-text: #8e8e93; 
            --green: #34c759; --red: #ff3b30; --radius-lg: 24px;
        }

        body { font-family: -apple-system, system-ui; background: var(--secondary-bg); color: var(--text); margin: 0; padding-bottom: 120px; }
        
        /* Telegram Wallet Style Header */
        .wallet-header { padding: 40px 20px 25px; text-align: center; background: var(--bg); border-radius: 0 0 30px 30px; margin-bottom: 10px; }
        .balance-label { font-size: 14px; color: var(--secondary-text); margin-bottom: 5px; }
        .balance-val { font-size: 42px; font-weight: 700; letter-spacing: -1px; }

        /* Динамический фильтр месяцев */
        .filter-row { display: flex; overflow-x: auto; padding: 10px 16px; gap: 8px; scrollbar-width: none; }
        .filter-row::-webkit-scrollbar { display: none; }
        .chip { padding: 8px 16px; background: #fff; border-radius: 20px; font-size: 14px; white-space: nowrap; border: 1px solid #eee; }
        .chip.active { background: var(--text); color: #fff; border-color: var(--text); }

        /* Плавающее меню (как в Wallet) */
        .nav-bar { 
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(255,255,255,0.95);
            backdrop-filter: blur(15px); display: flex; padding: 12px 10px;
            border-radius: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 1000;
        }
        .nav-item { flex: 1; text-align: center; color: #8e8e93; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: 0.2s; }
        .nav-item i { width: 22px; height: 22px; }
        .nav-item.active { color: var(--accent); }
        .nav-item.active i { transform: scale(1.1); }

        /* Скелетоны */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 10px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Карточки и элементы списка */
        .card { background: var(--card); margin: 0 16px 12px; padding: 16px; border-radius: var(--radius-lg); box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .list-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 0.5px solid #f0f0f0; }
        .list-item:last-child { border-bottom: none; }

        /* Копилка детали */
        .savings-controls { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; gap: 10px; }
        .expanded .savings-controls { display: flex; }
        .progress-bar { width: 100%; height: 8px; background: #eee; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--green); transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Модальные окна */
        .modal { position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff; border-radius: 25px 25px 0 0; z-index: 2000; transition: 0.3s; padding: 20px; box-sizing: border-box; }
        .modal.open { bottom: 0; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1999; }
        
        .input-group { background: var(--secondary-bg); border-radius: 15px; padding: 12px; margin-bottom: 12px; border: none; width: 100%; box-sizing: border-box; font-size: 16px; }
        .btn-main { width: 100%; padding: 16px; background: var(--accent); color: #fff; border-radius: 15px; border: none; font-weight: 600; font-size: 16px; }
    </style>
</head>
<body>

    <div class="wallet-header">
        <div class="balance-label">Общий баланс</div>
        <div class="balance-val"><span id="totalBalance">0.00</span> <span style="font-size: 20px; vertical-align: middle; opacity: 0.5">BYN</span></div>
    </div>

    <div id="filterArea"></div>
    <div id="app-content"></div>

    <div class="add-btn" style="position:fixed; bottom:100px; right:20px; width:56px; height:56px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; box-shadow: 0 4px 12px rgba(0,122,255,0.4); z-index:900" onclick="openModal('add')">
        <i data-lucide="plus"></i>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('budget', this)"><i data-lucide="wallet"></i><div>Кошелек</div></div>
        <div class="nav-item" onclick="switchTab('loans', this)"><i data-lucide="credit-card"></i><div>Рассрочки</div></div>
        <div class="nav-item" onclick="switchTab('savings', this)"><i data-lucide="piggy-bank"></i><div>Бонусы</div></div>
        <div class="nav-item" onclick="switchTab('shopping', this)"><i data-lucide="shopping-cart"></i><div>История</div></div>
    </nav>

    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    <div class="modal" id="modal">
        <div style="width: 40px; height: 4px; background: #ddd; border-radius: 2px; margin: 0 auto 20px;"></div>
        <h3 id="modalTitle" style="margin-top:0">Добавить операцию</h3>
        <select id="mType" class="input-group" onchange="toggleModalFields()">
            <option value="expense">Расход</option>
            <option value="income">Доход</option>
        </select>
        <input type="number" id="mAmount" class="input-group" placeholder="Сумма" inputmode="decimal">
        <input type="text" id="mCategory" class="input-group" placeholder="Категория">
        <input type="text" id="mComment" class="input-group" placeholder="Комментарий">
        <button class="btn-main" onclick="handleSave()">Сохранить</button>
        <button class="btn-main" id="delBtn" style="background:none; color:var(--red); margin-top:10px; display:none" onclick="handleDelete()">Удалить</button>
    </div>

<script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbz984B43cqvyhFyJXTMM5hPNslwvgYsqtpRwiLs4h7886XLirV-QakCMRoTzglf3lC2Vw/exec"; 
    let currentTab = 'budget';
    let currentMonth = new Date().getMonth() + 1;
    let currentYear = new Date().getFullYear();
    let currentData = [];

    async function init() {
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }
        lucide.createIcons();
        await loadData();
    }

    // --- ЛОГИКА ЗАГРУЗКИ (Скелетоны и Фильтры) ---
    async function loadData() {
        renderSkeleton();
        try {
            let action = `get${currentTab.charAt(0).toUpperCase() + currentTab.slice(1)}`;
            let url = `${SHEET_URL}?action=${action}`;
            if (currentTab === 'budget') url += `&month=${currentMonth}&year=${currentYear}`;

            const response = await fetch(url);
            const data = await response.json();
            currentData = data;

            if (currentTab === 'budget') {
                document.getElementById('totalBalance').textContent = data.totalBalance.toFixed(2);
                renderMonthFilter(data.activeMonths);
                renderBudget(data.operations);
            } else if (currentTab === 'loans') renderLoans(data);
            else if (currentTab === 'savings') renderSavings(data);
            else if (currentTab === 'shopping') renderShopping(data);

        } catch (e) {
            document.getElementById('app-content').innerHTML = `<div class="card" style="text-align:center">Ошибка загрузки. Проверьте соединение.</div>`;
        }
        lucide.createIcons();
    }

    function renderMonthFilter(months) {
        if (!months) return;
        let html = '<div class="filter-row">';
        html += `<div class="chip ${currentMonth === -1 ? 'active' : ''}" onclick="setFilter(-1, -1)">Все</div>`;
        months.sort((a,b) => b.year - a.year || b.month - a.month).forEach(m => {
            const names = ["","Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];
            const active = (m.month == currentMonth && m.year == currentYear) ? 'active' : '';
            html += `<div class="chip ${active}" onclick="setFilter(${m.month}, ${m.year})">${names[m.month]} ${m.year}</div>`;
        });
        document.getElementById('filterArea').innerHTML = html + '</div>';
    }

    function setFilter(m, y) {
        currentMonth = m; currentYear = y;
        loadData();
    }

    // --- ВАШИ ОРИГИНАЛЬНЫЕ ФУНКЦИИ ОТРИСОВКИ (ВОССТАНОВЛЕНО) ---
    function renderBudget(items) {
        let html = '<div class="card animate__animated animate__fadeInUp">';
        if (items.length === 0) html += '<p style="text-align:center; color:gray">Нет операций</p>';
        items.forEach(op => {
            const isInc = op.type === 'income';
            html += `
            <div class="list-item" onclick="openEditModal(${JSON.stringify(op).replace(/"/g, '&quot;')})">
                <div style="width:40px; height:40px; border-radius:50%; background:var(--secondary-bg); display:flex; align-items:center; justify-content:center; margin-right:12px">
                    <i data-lucide="${isInc ? 'arrow-down-left' : 'shopping-bag'}" style="color:${isInc ? 'var(--green)' : 'var(--text)'}; width:18px"></i>
                </div>
                <div style="flex:1">
                    <div style="font-weight:600">${op.category}</div>
                    <div style="font-size:12px; color:var(--secondary-text)">${op.date} ${op.comment ? '• '+op.comment : ''}</div>
                </div>
                <div style="font-weight:700; color:${isInc ? 'var(--green)' : 'var(--text)'}">${isInc ? '+' : '-'}${op.amount.toFixed(2)}</div>
            </div>`;
        });
        document.getElementById('app-content').innerHTML = html + '</div>';
    }

    function renderLoans(data) {
        let html = '<div class="animate__animated animate__fadeIn">';
        data.forEach(item => {
            html += `<div class="card">
                <div style="display:flex; justify-content:space-between"><b>${item.Name || item['Название']}</b> <span>${item.Price || item['Сумма']} BYN</span></div>
                <div style="font-size:12px; color:gray; margin-top:4px">Осталось: ${item.Left || '0'} платежей</div>
            </div>`;
        });
        document.getElementById('app-content').innerHTML = html || '<p style="text-align:center">Пусто</p>';
    }

    function renderSavings(data) {
        let html = '<div class="animate__animated animate__fadeIn">';
        data.forEach(s => {
            const cur = parseFloat(s.Current || s['Текущее'] || 0);
            const tar = parseFloat(s.Target || s['Цель'] || 1);
            const progress = Math.min(100, Math.round((cur / tar) * 100));
            html += `
            <div class="card" onclick="this.classList.toggle('expanded')">
                <div style="display:flex; justify-content:space-between">
                    <b>${s.Name || s['Название']}</b>
                    <b style="color:var(--green)">${progress}%</b>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:12px; color:gray">
                    <span>${cur} BYN</span><span>из ${tar} BYN</span>
                </div>
                <div class="savings-controls">
                    <button class="btn-main" style="flex:1; padding:10px" onclick="updateSaving(${s.rowId}, ${cur}, 'add')">+ Пополнить</button>
                    <button class="btn-main" style="flex:1; padding:10px; background:#f0f0f0; color:var(--text)" onclick="updateSaving(${s.rowId}, ${cur}, 'edit')">Изменить</button>
                </div>
            </div>`;
        });
        document.getElementById('app-content').innerHTML = html;
    }

    function renderShopping(data) {
        let html = '<div class="card animate__animated animate__fadeIn">';
        data.forEach(item => {
            html += `<div class="list-item">
                <div style="flex:1"><b>${item.Item || item['Товар']}</b></div>
                <div style="color:var(--secondary-text)">${item.Store || item['Магазин']}</div>
            </div>`;
        });
        document.getElementById('app-content').innerHTML = html + '</div>';
    }

    // --- ЛОГИКА УПРАВЛЕНИЯ (ADD / EDIT / DELETE) ---
    async function updateSaving(id, current, mode) {
        event.stopPropagation();
        if (mode === 'add') {
            const amt = prompt("Сколько добавить?");
            if (!amt) return;
            await sendRequest('edit', 'Savings', id, [null, current + parseFloat(amt)]);
        } else {
            const newTarget = prompt("Новая сумма цели?");
            if (newTarget) await sendRequest('edit', 'Savings', id, [null, null, parseFloat(newTarget)]);
        }
        loadData();
    }

    async function sendRequest(action, sheet, rowId, values) {
        await fetch(SHEET_URL, {
            method: 'POST',
            body: JSON.stringify({ action, sheet, rowId, values })
        });
        haptic('success');
    }

    function switchTab(tab, el) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        currentTab = tab;
        document.getElementById('filterArea').innerHTML = '';
        loadData();
        haptic('light');
    }

    function renderSkeleton() {
        let html = '<div class="card">';
        for(let i=0; i<3; i++) html += `<div class="skeleton" style="height:50px; margin-bottom:15px"></div>`;
        document.getElementById('app-content').innerHTML = html + '</div>';
    }

    function haptic(type) {
        if (window.Telegram?.WebApp?.HapticFeedback) {
            if (type === 'light') window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            if (type === 'success') window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
    }

    function openModal(mode) {
        document.getElementById('modal').classList.add('open');
        document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('open');
        document.getElementById('overlay').style.display = 'none';
    }

    init();
</script>
</body>
</html>

