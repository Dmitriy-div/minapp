<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç –∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∞</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

body { font-family: 'Roboto', sans-serif; max-width:480px; margin:auto; padding:16px; background:#f0f2f5; color:#333; }
h2 { text-align:center; color:#2f80ed; }

.card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin:12px 0; }
input, select { width:100%; padding:12px; margin:6px 0; border-radius:8px; border:1px solid #ddd; font-size:16px; }
button { width:100%; padding:12px; margin-top:12px; border-radius:10px; border:none; background:#2f80ed; color:#fff; font-size:18px; cursor:pointer; transition:0.2s; }
button:hover { background:#1366d6; }

#totals { display:flex; justify-content:space-between; margin-top:12px; }
.total-card { flex:1; background:#fff; border-radius:12px; padding:16px; margin:4px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.08); transition:transform 0.3s, background 0.3s; }

canvas { margin-top:16px; border-radius:12px; background:#fff; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }

.operations-container { margin-top:16px; max-height:300px; overflow-y:auto; position:relative; }

.operation-card {
  display:flex; justify-content:space-between; padding:12px; margin-bottom:8px; border-radius:10px;
  background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.06); opacity:0; transform:translateY(-20px);
  transition:opacity 0.5s, transform 0.5s, background 0.5s;
}

.operation-income { border-left:5px solid #4caf50; }
.operation-expense { border-left:5px solid #f44336; }
.new-operation { background:#fff7d6; }
.fade-out { opacity:0; transform:translateY(-20px); }
.fade-in { opacity:1; transform:translateY(0); }
</style>
</head>

<body>
<h2>üí∞ –°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</h2>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<div class="card">
  <button onclick="showPage('budget')">–ë—é–¥–∂–µ—Ç</button>
  <button onclick="showPage('loans')">–†–∞—Å—Å—Ä–æ—á–∫–∞</button>
</div>

<!-- –°–¢–†–ê–ù–ò–¶–ê –ë–Æ–î–ñ–ï–¢ -->
<div id="budgetPage">
  <div class="card">
    <select id="type">
      <option value="income">–î–æ—Ö–æ–¥</option>
      <option value="expense">–†–∞—Å—Ö–æ–¥</option>
    </select>
    <input id="amount" type="number" placeholder="–°—É–º–º–∞">
    <select id="category"></select>
    <input id="comment" type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
    <button onclick="save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

  <div class="card">
    <h3>–§–∏–ª—å—Ç—Ä –ø–æ –º–µ—Å—è—Ü—É</h3>
    <select id="filterMonth"></select>
    <select id="filterYear"></select>
    <button onclick="loadReport()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
  </div>

  <div id="totals">
    <div class="total-card" id="incomeCard"><h4>–î–æ—Ö–æ–¥</h4><p id="totalIncome">0</p></div>
    <div class="total-card" id="expenseCard"><h4>–†–∞—Å—Ö–æ–¥</h4><p id="totalExpense">0</p></div>
  </div>

  <canvas id="expenseChart" width="400" height="200"></canvas>

  <div class="card">
    <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
    <div class="operations-container" id="operationsContainer"></div>
  </div>
</div>

<!-- –°–¢–†–ê–ù–ò–¶–ê –†–ê–°–°–†–û–ß–ö–ò -->
<div id="loansPage" style="display:none;">
  <div class="card">
    <h3>–¢—Ä–µ–∫–µ—Ä —Ä–∞—Å—Å—Ä–æ—á–∫–∏</h3>
    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
    <div id="loanProgress" style="background:#ddd;border-radius:12px;overflow:hidden;height:24px;margin-bottom:12px;">
      <div id="loanProgressBar" style="height:100%;width:0%;background:#2f80ed;transition:width 0.5s;"></div>
    </div>
    <!-- –ì—Ä–∞—Ñ–∏–∫ -->
    <canvas id="loanChart" width="400" height="200" style="margin-bottom:12px;"></canvas>
    <div id="loansContainer"></div>
  </div>

  <div class="card">
    <h4>–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂</h4>
    <input type="date" id="loanDate">
    <input type="number" id="loanAmount" placeholder="–°—É–º–º–∞">
    <input type="text" id="loanComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
    <button onclick="addLoan()">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂</button>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
const user = tg.initDataUnsafe?.user || { id:0 };

const SHEET_URL = "https://script.google.com/macros/s/AKfycbx9R6_fJ9YiRlSujc93Pc_tRci_MwCpvDTLjdZrIFff1VO2rY_s4dyB3OXnNoELbTN7BQ/exec"; // –í—Å—Ç–∞–≤—å —Å–≤–æ–π URL Apps Script

/* ---------- –ù–∞–≤–∏–≥–∞—Ü–∏—è ---------- */
const budgetPage = document.getElementById("budgetPage");
const loansPage = document.getElementById("loansPage");
function showPage(page){
  if(page==='budget'){ budgetPage.style.display='block'; loansPage.style.display='none'; }
  else { budgetPage.style.display='none'; loansPage.style.display='block'; loadLoans(); }
}

/* ---------- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ---------- */
const categories = {
  income:["–ó–∞—Ä–ø–ª–∞—Ç–∞","–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞","–ü–æ–¥–∞—Ä–∫–∏","–ü—Ä–æ—á–µ–µ"],
  expense:["–ü—Ä–æ–¥—É–∫—Ç—ã","–ñ–∏–ª—å—ë","–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç","–î–µ—Ç–∏","–ó–¥–æ—Ä–æ–≤—å–µ","–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è","–û–¥–µ–∂–¥–∞","–ü—Ä–æ—á–µ–µ"]
};
function updateCategories() {
  const type = document.getElementById("type").value;
  const select = document.getElementById("category");
  select.innerHTML="";
  categories[type].forEach(cat=>{
    const option = document.createElement("option");
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });
}
document.getElementById("type").addEventListener("change", updateCategories);
updateCategories();

/* ---------- –§–∏–ª—å—Ç—Ä—ã ---------- */
const monthSelect = document.getElementById("filterMonth");
const yearSelect = document.getElementById("filterYear");
const months = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
const currentMonth = new Date().getMonth();
const currentYear = new Date().getFullYear();
months.forEach((m,i)=>monthSelect.options.add(new Option(m,i+1)));
monthSelect.value=currentMonth+1;
for(let y=currentYear-5;y<=currentYear+1;y++) yearSelect.options.add(new Option(y,y));
yearSelect.value=currentYear;

/* ---------- –ë—é–¥–∂–µ—Ç ---------- */
let chartInstance = null;
async function save(){
  const data = {
    type: document.getElementById("type").value,
    amount: document.getElementById("amount").value,
    category: document.getElementById("category").value,
    comment: document.getElementById("comment").value,
    user_id: user.id
  };
  if(!data.amount){
    tg.showPopup({title:"–û—à–∏–±–∫–∞", message:"–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É", buttons:[{type:"ok"}]});
    return;
  }
  try{
    await fetch(SHEET_URL,{method:"POST",mode:"no-cors",body:JSON.stringify(data)});
    document.getElementById("amount").value="";
    document.getElementById("comment").value="";
    tg.showPopup({title:"–ì–æ—Ç–æ–≤–æ ‚úÖ", message:"–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞", buttons:[{type:"ok"}]});
    loadReport(true);
  }catch(e){ console.error(e); tg.showPopup({title:"–û—à–∏–±–∫–∞ ‚ùå", message:"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å", buttons:[{type:"ok"}]}); }
}

async function loadReport(highlightNew=false){
  try{
    const month = monthSelect.value;
    const year = yearSelect.value;
    const res = await fetch(`${SHEET_URL}?month=${month}&year=${year}`);
    const data = await res.json();

    animateValue("totalIncome", parseFloat(document.getElementById("totalIncome").textContent), data.totalIncome);
    animateValue("totalExpense", parseFloat(document.getElementById("totalExpense").textContent), data.totalExpense);

    // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const labels = Object.keys(data.categorySums);
    const values = Object.values(data.categorySums);
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx,{
      type:'pie',
      data:{labels, datasets:[{label:'–†–∞—Å—Ö–æ–¥—ã', data:values, backgroundColor:['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#C9CBCF','#FF6666']}]},
      options:{responsive:true, plugins:{legend:{position:'bottom'}}, animation:{animateScale:true, animateRotate:true}}
    });

    // –û–ø–µ—Ä–∞—Ü–∏–∏
    const container = document.getElementById("operationsContainer");
    const oldCards = Array.from(container.children);
    oldCards.forEach(c=>c.classList.add("fade-out"));
    setTimeout(()=>{
      container.innerHTML="";
      data.operations.reverse().forEach((op,i)=>{
        const div = document.createElement("div");
        div.className="operation-card "+(op.type==="income"?"operation-income":"operation-expense");
        if(highlightNew && i===0) div.classList.add("new-operation");
        div.innerHTML=`<div>${op.date}</div><div>${op.type}</div><div>${op.amount}</div><div>${op.category}</div><div>${op.comment}</div>`;
        container.appendChild(div);
        setTimeout(()=>div.classList.add("fade-in"),10);
        if(highlightNew && i===0) setTimeout(()=>div.classList.remove("new-operation"),2000);
      });
    },300);

  }catch(e){ console.error(e); }
}

function animateValue(id,start,end,duration=600){
  const obj = document.getElementById(id);
  const range = end-start;
  let startTime=null;
  function step(timestamp){
    if(!startTime) startTime=timestamp;
    const progress=Math.min((timestamp-startTime)/duration,1);
    obj.textContent=(start+range*progress).toFixed(2);
    if(progress<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

loadReport();

/* ---------- –¢—Ä–µ–∫–µ—Ä —Ä–∞—Å—Å—Ä–æ—á–∫–∏ ---------- */
let loansData = [];
let loanChart = null;

function addLoan(){
  const date = document.getElementById("loanDate").value;
  const amount = parseFloat(document.getElementById("loanAmount").value);
  const comment = document.getElementById("loanComment").value;
  if(!date || !amount) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ —Å—É–º–º—É");
  loansData.push({date, amount, comment, paid:false});
  document.getElementById("loanDate").value="";
  document.getElementById("loanAmount").value="";
  document.getElementById("loanComment").value="";
  loadLoans();
}

function togglePaid(index){
  loansData[index].paid = !loansData[index].paid;
  loadLoans();
}

function loadLoans(){
  const container = document.getElementById("loansContainer");
  container.innerHTML="";
  let total=0, paid=0;

  loansData.forEach((loan,i)=>{
    total += loan.amount;
    if(loan.paid) paid += loan.amount;
    const div = document.createElement("div");
    div.className="operation-card "+(loan.paid?"operation-income":"operation-expense");
    div.innerHTML=`<div>${loan.date}</div><div>${loan.amount.toFixed(2)}‚Ç¨</div><div>${loan.comment}</div><button onclick="togglePaid(${i})">${loan.paid?"–û—Ç–º–µ–Ω–∏—Ç—å":"–û–ø–ª–∞—á–µ–Ω–æ"}</button>`;
    container.appendChild(div);
  });

  const progress = total? Math.round((paid/total)*100) : 0;
  document.getElementById("loanProgressBar").style.width = progress+"%";

  // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Å—Ä–æ—á–∫–∏
  const ctx = document.getElementById('loanChart').getContext('2d');
  const labels = loansData.map(l=>l.date);
  const paidData = loansData.map(l=>l.paid?l.amount:0);
  const unpaidData = loansData.map(l=>l.paid?0:l.amount);

  if(loanChart) loanChart.destroy();
  loanChart = new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[
      {label:'–û–ø–ª–∞—á–µ–Ω–æ', data:paidData, backgroundColor:'#2f80ed'},
      {label:'–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ', data:unpaidData, backgroundColor:'#f44336'}
    ]},
    options:{responsive:true, plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:true}}}
  });
}
</script>
</body>
</html>
