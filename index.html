<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 420px;
  margin: auto;
  padding: 16px;
}
select, input, button {
  width: 100%;
  margin: 6px 0;
  padding: 10px;
  font-size: 16px;
}
button {
  background: #2ea6ff;
  color: white;
  border: none;
  border-radius: 6px;
}
h3 { margin-top: 20px; }
</style>
</head>

<body>
<h2>üí∞ –°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</h2>

<select id="type">
  <option value="income">–î–æ—Ö–æ–¥</option>
  <option value="expense">–†–∞—Å—Ö–æ–¥</option>
</select>

<input id="amount" type="number" placeholder="–°—É–º–º–∞">

<select id="category"></select>

<input id="comment" type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">

<button onclick="save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

<h3>–û—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü</h3>
<div>
  –î–æ—Ö–æ–¥: <span id="totalIncome">0</span> | –†–∞—Å—Ö–æ–¥: <span id="totalExpense">0</span>
</div>
<canvas id="expenseChart" width="400" height="200"></canvas>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const user = tg.initDataUnsafe?.user || { id: 0 };

/* üî¥ –í–°–¢–ê–í–¨ –°–í–û–ô WEB APP URL */
const SHEET_URL = "https://script.google.com/macros/s/AKfycbxbGoASp4tI1EpEfwUME-M54XVXQcnqhlQ55qunaa3Edv2mLFkXQuU16Y-Sci2SJ6kwYQ/exec";

/* üîπ –ö–ê–¢–ï–ì–û–†–ò–ò */
const categories = {
  income: [
    "–ó–∞—Ä–ø–ª–∞—Ç–∞","–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞","–ü–æ–¥–∞—Ä–∫–∏","–ü—Ä–æ—á–µ–µ"
  ],
  expense: [
    "–ü—Ä–æ–¥—É–∫—Ç—ã","–ñ–∏–ª—å—ë","–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç","–î–µ—Ç–∏","–ó–¥–æ—Ä–æ–≤—å–µ","–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è","–û–¥–µ–∂–¥–∞","–ü—Ä–æ—á–µ–µ"
  ]
};

/* –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞ */
function updateCategories() {
  const type = document.getElementById("type").value;
  const select = document.getElementById("category");
  select.innerHTML = "";
  categories[type].forEach(cat=>{
    const option = document.createElement("option");
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });
}
document.getElementById("type").addEventListener("change", updateCategories);
updateCategories();

/* üîπ –°–û–•–†–ê–ù–ï–ù–ò–ï */
async function save() {
  const data = {
    type: document.getElementById("type").value,
    amount: document.getElementById("amount").value,
    category: document.getElementById("category").value,
    comment: document.getElementById("comment").value,
    user_id: user.id
  };

  if (!data.amount) {
    tg.showPopup({title:"–û—à–∏–±–∫–∞", message:"–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É", buttons:[{type:"ok"}]});
    return;
  }

  try {
    await fetch(SHEET_URL, { method:"POST", mode:"no-cors", body:JSON.stringify(data) });

    document.getElementById("amount").value = "";
    document.getElementById("comment").value = "";

    tg.showPopup({
      title:"–ì–æ—Ç–æ–≤–æ ‚úÖ",
      message:"–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±—é–¥–∂–µ—Ç",
      buttons:[{type:"ok"}]
    });

    loadReport(); // –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—á–µ—Ç

  } catch(e) {
    console.error(e);
    tg.showPopup({title:"–û—à–∏–±–∫–∞ ‚ùå", message:"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å", buttons:[{type:"ok"}]});
  }
}

/* üîπ –ó–ê–ì–†–£–ó–ö–ê –û–¢–ß–ï–¢–ê */
async function loadReport() {
  try {
    const res = await fetch(SHEET_URL);
    const data = await res.json();

    document.getElementById("totalIncome").textContent = data.totalIncome.toFixed(2);
    document.getElementById("totalExpense").textContent = data.totalExpense.toFixed(2);

    const ctx = document.getElementById('expenseChart').getContext('2d');
    const labels = Object.keys(data.categorySums);
    const values = Object.values(data.categorySums);

    new Chart(ctx, {
      type: 'pie',
      data: { labels: labels, datasets:[{label:'–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º', data: values,
        backgroundColor:['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#C9CBCF','#FF6666']
      }]},
      options:{responsive:true, plugins:{legend:{position:'bottom'}}}
    });

  } catch(e) {
    console.error(e);
  }
}

loadReport();
</script>
</body>
</html>
