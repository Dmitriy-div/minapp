<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Flow Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { 
            --bg: #f2f2f7; 
            --accent: #2481cc; /* Цвет Wallet */
            --card: #ffffff; 
            --text: #000000; 
            --secondary: #8e8e93; 
            --green: #34c759; 
            --red: #ff3b30; 
            --radius: 20px; 
            --skeleton: #e5e5ea;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000; --card: #1c1c1e; --text: #ffffff; --skeleton: #2c2c2e;
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 120px; }

        /* Анимации нажатий (эффект как в Wallet) */
        .clickable { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .clickable:active { transform: scale(0.96); }

        .balance-header { padding: 30px 20px 10px; text-align: center; }
        .balance-label { font-size: 14px; color: var(--secondary); font-weight: 500; margin-bottom: 4px; }
        .balance-amount { font-size: 42px; font-weight: 700; letter-spacing: -1px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        
        .card { background: var(--card); margin: 16px; padding: 20px; border-radius: var(--radius); box-shadow: 0 4px 20px rgba(0,0,0,0.03); }

        /* Фильтр месяцев */
        .month-filter-wrap { padding: 0 16px; margin-top: -5px; }
        select.month-select { appearance: none; background: var(--card); color: var(--accent); border: none; padding: 8px 16px; border-radius: 12px; font-weight: 600; font-size: 15px; outline: none; display: inline-block; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }

        /* История */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 0.5px solid var(--skeleton); }
        .history-item:last-child { border-bottom: none; padding-bottom: 0; }
        .history-date { font-size: 11px; color: var(--secondary); margin-bottom: 2px;}
        .history-cat { font-weight: 600; font-size: 16px; display: block; color: var(--text); }
        .history-comm { font-size: 13px; color: var(--secondary); margin-top: 2px;}
        .history-amt { font-weight: 700; font-size: 17px; }

        /* Skeleton Loaders */
        .skeleton { background: var(--skeleton); border-radius: 8px; overflow: hidden; position: relative; }
        .skeleton::after {
            content: ""; position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg, rgba(255, 255, 255, 0) 0, rgba(255, 255, 255, 0.2) 20%, rgba(255, 255, 255, 0.5) 60%, rgba(255, 255, 255, 0));
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .skeleton-text { height: 16px; margin-bottom: 8px; border-radius: 6px; }
        .skeleton-title { height: 24px; width: 40%; margin-bottom: 16px; border-radius: 8px;}

        /* Bottom Menu Wallet Style */
        .nav-bar { 
            position: fixed; bottom: 20px; left: 20px; right: 20px; 
            background: var(--card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; padding: 12px 5px; border-radius: 28px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); z-index: 1000; 
        }
        .nav-item { flex: 1; text-align: center; color: var(--secondary); font-size: 11px; font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: color 0.2s; }
        .nav-item.active { color: var(--accent); }
        .nav-item svg { width: 22px; height: 22px; stroke-width: 2.2; }

        /* Плавающая кнопка добавления */
        .add-btn { position: fixed; bottom: 100px; right: 24px; width: 56px; height: 56px; background: var(--accent); color: white; border-radius: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px rgba(36, 129, 204, 0.4); z-index: 999; }

        /* Модалка (Bottom Sheet) */
        .modal-sheet { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card); border-radius: 24px 24px 0 0; padding: 20px 20px 40px; transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); }
        .modal-sheet.active { transform: translateY(0); }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); opacity:0; pointer-events:none; transition: 0.3s; z-index: 1999; }
        .overlay.active { opacity:1; pointer-events:auto; }

        .input-pill { width: 100%; background: var(--bg); color: var(--text); border: none; padding: 16px; border-radius: 16px; margin-bottom: 12px; font-size: 16px; outline: none; font-weight: 500;}
        .main-btn { width: 100%; background: var(--accent); color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 600; font-size: 16px; margin-top: 10px; }
        .danger-btn { background: #ffe5e5; color: var(--red); flex: 1; border: none; padding: 16px; border-radius: 16px; font-weight: 600; font-size: 16px; }

        /* Прогресс-бары */
        .pb-bg { background: var(--bg); height: 8px; border-radius: 4px; margin: 12px 0; overflow: hidden; }
        .pb-fill { height: 100%; transition: 1s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 4px; }

        .shop-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 0.5px solid var(--skeleton); font-weight: 500; font-size: 16px; }
        .shop-item.bought { opacity: 0.5; text-decoration: line-through; }
        .check-box { width: 24px; height: 24px; border: 2px solid var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .check-box.active { background: var(--accent); color: white; border-color: var(--accent); }
    </style>
</head>
<body>
    <div class="balance-header">
        <div class="balance-label">Общий баланс</div>
        <div class="balance-amount"><span id="totalBalance">0.00</span> <span style="font-size: 24px; font-weight: 600;">BYN</span></div>
    </div>

    <div id="monthFilterContainer" class="month-filter-wrap" style="display:none;">
        <select id="monthSelect" class="month-select clickable" onchange="changeMonth()"></select>
    </div>

    <div id="app-content">
        </div>

    <div class="add-btn clickable" onclick="openActionModal()"><i data-lucide="plus"></i></div>

    <nav class="nav-bar">
        <div class="nav-item active clickable" onclick="switchTab('budget', this)"><i data-lucide="wallet"></i>Бюджет</div>
        <div class="nav-item clickable" onclick="switchTab('loans', this)"><i data-lucide="credit-card"></i>Рассрочки</div>
        <div class="nav-item clickable" onclick="switchTab('savings', this)"><i data-lucide="target"></i>Цели</div>
        <div class="nav-item clickable" onclick="switchTab('shopping', this)"><i data-lucide="shopping-basket"></i>Покупки</div>
    </nav>

    <div id="overlay" class="overlay" onclick="closeActionModal()"></div>
    
    <div id="actionModal" class="modal-sheet">
        <div style="width: 36px; height: 5px; background: var(--skeleton); border-radius: 3px; margin: 0 auto 20px;"></div>
        
        <input type="hidden" id="editRowId">
        <select id="mType" class="input-pill" onchange="updateCategories()">
            <option value="expense">Расход</option>
            <option value="income">Доход</option>
            <option value="savings">В копилку</option>
        </select>
        <input type="number" id="mAmount" class="input-pill" placeholder="Сумма" inputmode="decimal">
        <select id="mCategory" class="input-pill"></select>
        <input type="text" id="mComment" class="input-pill" placeholder="Комментарий (необязательно)">
        
        <div id="createBtnWrap">
            <button class="main-btn clickable" onclick="saveOperation()">Добавить транзакцию</button>
        </div>
        
        <div id="editBtnWrap" style="display:none; gap: 10px; margin-top: 10px;">
            <button class="danger-btn clickable" onclick="deleteOperation()"><i data-lucide="trash-2" style="width: 20px; height: 20px;"></i></button>
            <button class="main-btn clickable" style="flex: 4; margin-top: 0;" onclick="saveOperation()">Сохранить изменения</button>
        </div>
    </div>

<!-- укорочено описание стилей — они остаются без изменений -->
<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbwhOG4sxDU35mNr-i4ctu5XP83b-I1JGBJKbBHYNG-s8baHu4MXnKQ38oa0euP9khOYSQ/exec";

let currentTab = 'budget';
let savingsGoals = [];
let currentFilterMonth = null;
let currentFilterYear = null;

const CACHE_KEY = "finance_cache_v4";

function saveCache(key,data){
   const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || "{}");
   cache[key] = {time:Date.now(),data:data};
   localStorage.setItem(CACHE_KEY,JSON.stringify(cache));
}

function loadCache(key){
   const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || "{}");
   if(!cache[key]) return null;
   return cache[key].data;
}

async function apiGet(url,cacheKey){
   const cached = loadCache(cacheKey);
   if(cached) return cached;

   const res = await fetch(url);
   const data = await res.json();

   saveCache(cacheKey,data);
   return data;
}

async function apiPost(body){
   await fetch(SHEET_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
   });

   localStorage.removeItem(CACHE_KEY);
}

async function loadData(){
   const cont = document.getElementById('app-content');
   cont.innerHTML = getSkeletonHTML();

   try{
      let url = SHEET_URL;

      if(currentTab === "budget"){
         url += "?action=getBudget";

         if(currentFilterMonth){
            url += "&month="+currentFilterMonth+"&year="+currentFilterYear;
         }
      }
      else{
         url += "?action=get"+currentTab.charAt(0).toUpperCase()+currentTab.slice(1);
      }

      const data = await apiGet(url,currentTab);

      if(currentTab==="budget") renderBudget(data);
      if(currentTab==="loans") renderLoans(data);
      if(currentTab==="savings"){
         savingsGoals = data.map(x=>x.name);
         renderSavings(data);
      }
      if(currentTab==="shopping") renderShopping(data);

   }catch(e){
      cont.innerHTML='<div class="card">Ошибка сети</div>';
   }
}

async function saveOperation(){

   const id=document.getElementById('editRowId').value;

   const data={
      action: id ? "editOperation" : "addOperation",
      id:id,
      type:document.getElementById('mType').value,
      amount:Number(document.getElementById('mAmount').value),
      category:document.getElementById('mCategory').value,
      comment:document.getElementById('mComment').value,
      user_id:"user"
   };

   closeActionModal();

   await apiPost(data);
   loadData();
}

async function deleteOperation(){
   const id=document.getElementById('editRowId').value;
   if(!id) return;

   closeActionModal();

   await apiPost({
      action:"deleteOperation",
      id:Number(id)
   });

   loadData();
}

/* фикс процентов рассрочки */
function renderLoans(data){

   let html='<div>';

   data.forEach(l=>{

      let percent=0;
      if(l.total>0){
         percent=Math.round(((l.total-l.balance)/l.total)*100);
      }

      percent=Math.max(0,Math.min(percent,100));

      html+=`
      <div class="card">
         <div style="display:flex;justify-content:space-between">
            <b>${l.name}</b>
            <span>${percent}%</span>
         </div>

         <div class="pb-bg">
            <div class="pb-fill" style="width:${percent}%"></div>
         </div>

         <div style="font-size:12px">
            Остаток ${Number(l.balance).toFixed(2)}
         </div>
      </div>`;
   });

   contHTML(html+'</div>');
}
</script>
</body>
</html>

